import{r as i,_ as E,j as R}from"./index-6MI9PjoD.js";let k,b,C;const $=({setDebugInfo:w,setError:a,onPoseResults:m})=>{const c=i.useRef(null),l=i.useRef(null),p=i.useRef(null),h=i.useRef(null),g=i.useRef(null),u=i.useRef(null),M=i.useRef(!0),[v,A]=i.useState(!1),[D,x]=i.useState(!1),[f,_]=i.useState(!1);i.useEffect(()=>()=>{M.current=!1,g.current&&g.current.getTracks().forEach(e=>e.stop()),h.current&&h.current.close(),u.current&&cancelAnimationFrame(u.current)},[]);const r=i.useCallback(e=>{if(M.current)try{console.log(`[PoseDetection] ${e}`);const t=new Date().toLocaleTimeString();w&&w(s=>[...s.slice(-9),`${t}: ${e}`])}catch(t){console.error("Debug info error:",t)}},[w]),F=i.useCallback(async()=>{try{x(!0),r("Starting MediaPipe Tasks Vision initialization...");const e=await E(()=>import("./vision_bundle-DieMjNca.js"),[]);k=e.FilesetResolver,b=e.PoseLandmarker,C=e.DrawingUtils,r("MediaPipe modules imported successfully");const t=await k.forVisionTasks("https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.22/wasm");r("FilesetResolver initialized with CDN WASM path"),h.current=await new Promise((s,n)=>{b.createFromOptions(t,{baseOptions:{modelAssetPath:"https://storage.googleapis.com/mediapipe-models/pose_landmarker/pose_landmarker_lite/float16/1/pose_landmarker_lite.task"},runningMode:"VIDEO",numPoses:1}).then(o=>{s(o)}).catch(o=>{n(o)})}),r("PoseLandmarker created successfully"),A(!0),a&&a(null)}catch(e){let t="";e instanceof Error?t=e.message:typeof e=="object"&&e!==null?t=JSON.stringify(e):t=String(e),r(`MediaPipe initialization failed: ${t}`),a&&a(`MediaPipe初期化エラー: ${t}`),console.error("MediaPipe initialization error:",e)}finally{x(!1)}},[r,a]),S=i.useCallback(async()=>{if(M.current)try{if(r("Starting camera initialization..."),g.current&&g.current.getTracks().forEach(n=>n.stop()),!navigator.mediaDevices||!navigator.mediaDevices.getUserMedia){a&&a("エラー: お使いのブラウザはカメラアクセスをサポートしていません。"),r("MediaDevices API not supported.");return}const e=document.createElement("video");e.autoplay=!0,e.playsInline=!0,e.muted=!0,e.style.width="100%",e.style.height="100%",e.style.objectFit="cover",e.style.position="absolute",e.style.top="0",e.style.left="0";const t=document.createElement("canvas");if(t.style.width="100%",t.style.height="100%",t.style.position="absolute",t.style.top="0",t.style.left="0",t.style.pointerEvents="none",p.current)p.current.innerHTML="",p.current.appendChild(e),p.current.appendChild(t),c.current=e,l.current=t,r("Video and canvas elements created and added to DOM.");else{r("Container ref not available for video element."),a&&a("初期化エラー: ビデオコンテナが見つかりません。");return}const s=await navigator.mediaDevices.getUserMedia({video:!0});g.current=s,r(`Camera stream obtained with ${s.getTracks().length} tracks`),c.current?(c.current.srcObject=s,await c.current.play(),await new Promise(n=>{const o=()=>{c.current&&c.current.videoWidth>0?(l.current&&(l.current.width=c.current.videoWidth,l.current.height=c.current.videoHeight,r(`Canvas size set to ${l.current.width}x${l.current.height}`)),n()):setTimeout(o,100)};o()}),r("Camera stream started successfully."),_(!0)):(a&&a("エラー: ビデオ要素が準備できていません。"),r("Video element not ready for stream."))}catch(e){console.error("Camera access error:",e);let t="カメラアクセスに失敗しました。";e.name==="NotAllowedError"?t="カメラの使用が許可されませんでした。ブラウザの設定を確認してください。":e.name==="NotFoundError"?t="カメラが見つかりませんでした。接続を確認してください。":e.name==="NotReadableError"&&(t="カメラが既に使用中か、ハードウェアエラーが発生しました。"),a&&a(t),r(`Camera error: ${e.name} - ${e.message}`)}},[r,a]),z=e=>{const t=(s,n,o)=>{const P=Math.atan2(o.y-n.y,o.x-n.x)-Math.atan2(s.y-n.y,s.x-n.x);let d=Math.abs(P*180/Math.PI);return d>180&&(d=360-d),d};return{leftElbow:t(e[11],e[13],e[15]),rightElbow:t(e[12],e[14],e[16]),leftKnee:t(e[23],e[25],e[27]),rightKnee:t(e[24],e[26],e[28]),leftShoulder:t(e[13],e[11],e[23]),rightShoulder:t(e[14],e[12],e[24])}},y=i.useCallback(async()=>{if(!h.current||!c.current||!l.current||!f){u.current=requestAnimationFrame(y);return}try{const e=c.current,t=l.current,s=t.getContext("2d"),n=h.current.detectForVideo(e,performance.now());if(s.clearRect(0,0,t.width,t.height),n.landmarks&&n.landmarks.length>0){const o=new C(s);for(const d of n.landmarks)o.drawLandmarks(d,{radius:j=>C.lerp(j.from.z,-.15,.1,5,1)}),o.drawConnectors(d,b.POSE_CONNECTIONS,{color:"#00FF00",lineWidth:2});const P=z(n.landmarks[0]);m&&m({landmarks:n.landmarks[0],jointAngles:P,timestamp:Date.now()})}else m&&m(null);u.current=requestAnimationFrame(y)}catch(e){r(`Pose detection error: ${e.message}`),console.error("Pose detection error:",e),u.current=requestAnimationFrame(y)}},[f,m,r]);return i.useEffect(()=>{F()},[F]),i.useEffect(()=>{v&&!f&&S()},[v,f,S]),i.useEffect(()=>(v&&f&&(r("Starting pose detection loop..."),u.current=requestAnimationFrame(y)),()=>{u.current&&cancelAnimationFrame(u.current)}),[v,f,y,r]),R.jsx("div",{ref:p,className:"relative w-full bg-black",style:{paddingTop:"75%"},children:D&&R.jsx("div",{className:"absolute inset-0 flex items-center justify-center bg-black bg-opacity-75 text-white",children:R.jsx("p",{children:"MediaPipeとカメラを初期化中..."})})})};export{$ as default};
