import{r as i,_ as E,j as b}from"./index-ere0wXha.js";let k,C,P;const $=({setDebugInfo:w,setError:n,onPoseResults:m})=>{const o=i.useRef(null),c=i.useRef(null),p=i.useRef(null),g=i.useRef(null),h=i.useRef(null),l=i.useRef(null),M=i.useRef(!0),[v,A]=i.useState(!1),[D,x]=i.useState(!1),[f,_]=i.useState(!1);i.useEffect(()=>()=>{M.current=!1,h.current&&h.current.getTracks().forEach(e=>e.stop()),g.current&&g.current.close(),l.current&&cancelAnimationFrame(l.current)},[]);const r=i.useCallback(e=>{if(M.current)try{console.log(`[PoseDetection] ${e}`);const t=new Date().toLocaleTimeString();w&&w(s=>[...s.slice(-9),`${t}: ${e}`])}catch(t){console.error("Debug info error:",t)}},[w]),F=i.useCallback(async()=>{try{x(!0),r("Starting MediaPipe Tasks Vision initialization...");const e=await E(()=>import("./vision_bundle-DieMjNca.js"),[]);k=e.FilesetResolver,C=e.PoseLandmarker,P=e.DrawingUtils,r("MediaPipe modules imported successfully");const t=await k.forVisionTasks("https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.22");r("FilesetResolver initialized with CDN WASM path"),g.current=await C.createFromOptions(t,{baseOptions:{modelAssetPath:"https://storage.googleapis.com/mediapipe-models/pose_landmarker/pose_landmarker_lite/float16/latest/pose_landmarker_lite.task"},runningMode:"VIDEO",numPoses:1}),r("PoseLandmarker created successfully"),A(!0),n&&n(null)}catch(e){let t="";e instanceof Error?t=e.message:typeof e=="object"&&e!==null?t=JSON.stringify(e):t=String(e),r(`MediaPipe initialization failed: ${t}`),n&&n(`MediaPipe初期化エラー: ${t}`),console.error("MediaPipe initialization error:",e)}finally{x(!1)}},[r,n]),S=i.useCallback(async()=>{if(M.current)try{if(r("Starting camera initialization..."),h.current&&h.current.getTracks().forEach(a=>a.stop()),!navigator.mediaDevices||!navigator.mediaDevices.getUserMedia){n&&n("エラー: お使いのブラウザはカメラアクセスをサポートしていません。"),r("MediaDevices API not supported.");return}const e=document.createElement("video");e.autoplay=!0,e.playsInline=!0,e.muted=!0,e.style.width="100%",e.style.height="100%",e.style.objectFit="cover",e.style.position="absolute",e.style.top="0",e.style.left="0";const t=document.createElement("canvas");if(t.style.width="100%",t.style.height="100%",t.style.position="absolute",t.style.top="0",t.style.left="0",t.style.pointerEvents="none",p.current)p.current.innerHTML="",p.current.appendChild(e),p.current.appendChild(t),o.current=e,c.current=t,r("Video and canvas elements created and added to DOM.");else{r("Container ref not available for video element."),n&&n("初期化エラー: ビデオコンテナが見つかりません。");return}const s=await navigator.mediaDevices.getUserMedia({video:!0});h.current=s,r(`Camera stream obtained with ${s.getTracks().length} tracks`),o.current?(o.current.srcObject=s,await o.current.play(),await new Promise(a=>{const u=()=>{o.current&&o.current.videoWidth>0?(c.current&&(c.current.width=o.current.videoWidth,c.current.height=o.current.videoHeight,r(`Canvas size set to ${c.current.width}x${c.current.height}`)),a()):setTimeout(u,100)};u()}),r("Camera stream started successfully."),_(!0)):(n&&n("エラー: ビデオ要素が準備できていません。"),r("Video element not ready for stream."))}catch(e){console.error("Camera access error:",e);let t="カメラアクセスに失敗しました。";e.name==="NotAllowedError"?t="カメラの使用が許可されませんでした。ブラウザの設定を確認してください。":e.name==="NotFoundError"?t="カメラが見つかりませんでした。接続を確認してください。":e.name==="NotReadableError"&&(t="カメラが既に使用中か、ハードウェアエラーが発生しました。"),n&&n(t),r(`Camera error: ${e.name} - ${e.message}`)}},[r,n]),z=e=>{const t=(s,a,u)=>{const R=Math.atan2(u.y-a.y,u.x-a.x)-Math.atan2(s.y-a.y,s.x-a.x);let d=Math.abs(R*180/Math.PI);return d>180&&(d=360-d),d};return{leftElbow:t(e[11],e[13],e[15]),rightElbow:t(e[12],e[14],e[16]),leftKnee:t(e[23],e[25],e[27]),rightKnee:t(e[24],e[26],e[28]),leftShoulder:t(e[13],e[11],e[23]),rightShoulder:t(e[14],e[12],e[24])}},y=i.useCallback(async()=>{if(!g.current||!o.current||!c.current||!f){l.current=requestAnimationFrame(y);return}try{const e=o.current,t=c.current,s=t.getContext("2d"),a=g.current.detectForVideo(e,performance.now());if(s.clearRect(0,0,t.width,t.height),a.landmarks&&a.landmarks.length>0){const u=new P(s);for(const d of a.landmarks)u.drawLandmarks(d,{radius:j=>P.lerp(j.from.z,-.15,.1,5,1)}),u.drawConnectors(d,C.POSE_CONNECTIONS,{color:"#00FF00",lineWidth:2});const R=z(a.landmarks[0]);m&&m({landmarks:a.landmarks[0],jointAngles:R,timestamp:Date.now()})}else m&&m(null);l.current=requestAnimationFrame(y)}catch(e){r(`Pose detection error: ${e.message}`),console.error("Pose detection error:",e),l.current=requestAnimationFrame(y)}},[f,m,r]);return i.useEffect(()=>{F()},[F]),i.useEffect(()=>{v&&!f&&S()},[v,f,S]),i.useEffect(()=>(v&&f&&(r("Starting pose detection loop..."),l.current=requestAnimationFrame(y)),()=>{l.current&&cancelAnimationFrame(l.current)}),[v,f,y,r]),b.jsx("div",{ref:p,className:"relative w-full bg-black",style:{paddingTop:"75%"},children:D&&b.jsx("div",{className:"absolute inset-0 flex items-center justify-center bg-black bg-opacity-75 text-white",children:b.jsx("p",{children:"MediaPipeとカメラを初期化中..."})})})};export{$ as default};
