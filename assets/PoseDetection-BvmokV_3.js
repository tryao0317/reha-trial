import{r as s,_ as H,j as t,C as E,a as R,b as $,T as B,c as M,B as y,d as T}from"./index-CT1EkkIC.js";import{P as A,R as V}from"./rotate-ccw-BGmBXF_u.js";let O,P,k;const G=({onPoseResults:j,isActive:f})=>{const i=s.useRef(null),n=s.useRef(null),x=s.useRef(null),u=s.useRef(null),m=s.useRef(null),[p,S]=s.useState(!1),[L,z]=s.useState(!1),[D,o]=s.useState(null),[w,U]=s.useState([]),[l,v]=s.useState(!1),r=s.useCallback(e=>{try{console.log(`[PoseDetection] ${e}`);const a=new Date().toLocaleTimeString();U(c=>[...c.slice(-9),`${a}: ${e}`])}catch(a){console.error("Debug info error:",a)}},[]),N=s.useCallback(async()=>{try{z(!0),r("Starting MediaPipe Tasks Vision initialization...");const e=await H(()=>import("./vision_bundle-DieMjNca.js"),[]);O=e.FilesetResolver,P=e.PoseLandmarker,k=e.DrawingUtils,r("MediaPipe modules imported successfully");const a=await O.forVisionTasks("https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.22/wasm");r("FilesetResolver initialized with CDN WASM path"),x.current=await P.createFromOptions(a,{baseOptions:{modelAssetPath:"https://storage.googleapis.com/mediapipe-models/pose_landmarker/pose_landmarker_lite/float16/1/pose_landmarker_lite.task"},runningMode:"VIDEO",numPoses:1}),r("PoseLandmarker created successfully"),S(!0),o(null)}catch(e){r(`MediaPipe initialization failed: ${e.message}`),o(`MediaPipe初期化エラー: ${e.message}`),console.error("MediaPipe initialization error:",e)}finally{z(!1)}},[r]),_=s.useCallback(async()=>{try{if(r("Starting camera initialization..."),u.current&&u.current.getTracks().forEach(a=>a.stop()),!i.current){r("ERROR: Video element not found"),o("ビデオ要素が見つかりません");return}r("Video element confirmed, requesting camera access...");let e;try{e=await navigator.mediaDevices.getUserMedia({video:{width:{ideal:640},height:{ideal:480},facingMode:"user"}}),r("Camera access granted with detailed constraints")}catch(a){r(`First attempt failed: ${a.name} - ${a.message}`);try{e=await navigator.mediaDevices.getUserMedia({video:!0}),r("Camera access granted with basic constraints")}catch(c){throw r(`Second attempt failed: ${c.name} - ${c.message}`),c}}if(u.current=e,r(`Camera stream obtained with ${e.getTracks().length} tracks`),i.current){i.current.srcObject=e;try{await i.current.play(),r("Video element playing successfully"),n.current&&(n.current.width=i.current.videoWidth||640,n.current.height=i.current.videoHeight||480,r(`Canvas size set to ${n.current.width}x${n.current.height}`)),v(!0),o(null)}catch(a){r(`Video play failed: ${a.name} - ${a.message}`),a.name==="NotAllowedError"?(r("Autoplay blocked, user interaction required"),o("ビデオの再生にはユーザーの操作が必要です。下の「手動再生」ボタンをクリックしてください。")):o(`ビデオ再生エラー: ${a.message}`)}}}catch(e){r(`Camera initialization failed: ${e.name} - ${e.message}`);let a="カメラ初期化エラー";e.name==="NotFoundError"?a="カメラが見つかりません。デバイスにカメラが接続されているか確認してください。":e.name==="NotAllowedError"?a="カメラアクセスが拒否されました。ブラウザの設定でカメラの使用を許可してください。":e.name==="NotReadableError"?a="カメラが他のアプリケーションで使用中です。他のアプリを閉じてから再試行してください。":a=`カメラエラー: ${e.message}`,o(a),console.error("Camera initialization error:",e)}},[r]),b=s.useCallback(async()=>{if(!(!x.current||!i.current||!n.current||!l))try{const e=i.current,a=n.current,c=a.getContext("2d"),d=await x.current.detectForVideo(e,performance.now());if(c.clearRect(0,0,a.width,a.height),d.landmarks&&d.landmarks.length>0){const g=new k(c);for(const h of d.landmarks)g.drawLandmarks(h,{radius:q=>k.lerp(q.from.z,-.15,.1,5,1)}),g.drawConnectors(h,P.POSE_CONNECTIONS,{color:"#00FF00",lineWidth:2});const C=W(d.landmarks[0]);j&&j({landmarks:d.landmarks[0],jointAngles:C,timestamp:Date.now()})}f&&(m.current=requestAnimationFrame(b))}catch(e){r(`Pose detection error: ${e.message}`),console.error("Pose detection error:",e)}},[f,l,j,r]),W=e=>{const a=(c,d,g)=>{const C=Math.atan2(g.y-d.y,g.x-d.x)-Math.atan2(c.y-d.y,c.x-d.x);let h=Math.abs(C*180/Math.PI);return h>180&&(h=360-h),h};return{leftElbow:a(e[11],e[13],e[15]),rightElbow:a(e[12],e[14],e[16]),leftKnee:a(e[23],e[25],e[27]),rightKnee:a(e[24],e[26],e[28]),leftShoulder:a(e[13],e[11],e[23]),rightShoulder:a(e[14],e[12],e[24])}},F=s.useCallback(async()=>{if(!i.current||!u.current){r("Manual play failed: video or stream not available");return}try{r("Manual play attempt..."),await i.current.play(),r("Manual play successful"),n.current&&(n.current.width=i.current.videoWidth||640,n.current.height=i.current.videoHeight||480,r(`Canvas size set to ${n.current.width}x${n.current.height}`)),v(!0),o(null)}catch(e){r(`Manual play failed: ${e.message}`),o(`手動再生エラー: ${e.message}`)}},[r]);s.useEffect(()=>{N()},[N]),s.useEffect(()=>{p&&!l&&_()},[p,l,_]),s.useEffect(()=>(f&&p&&l?(r("Starting pose detection..."),b()):!f&&m.current&&(r("Stopping pose detection..."),cancelAnimationFrame(m.current),m.current=null),()=>{m.current&&cancelAnimationFrame(m.current)}),[f,p,l,b,r]),s.useEffect(()=>()=>{u.current&&u.current.getTracks().forEach(e=>e.stop()),x.current&&x.current.close(),m.current&&cancelAnimationFrame(m.current)},[]);const I=()=>{o(null),v(!1),S(!1),N()};return D?t.jsxs(E,{children:[t.jsx(R,{children:t.jsxs($,{className:"flex items-center gap-2 text-red-600",children:[t.jsx(B,{className:"h-5 w-5"}),"エラーが発生しました"]})}),t.jsxs(M,{className:"space-y-4",children:[t.jsx("p",{className:"text-gray-600",children:D}),u.current&&t.jsxs(y,{onClick:F,className:"w-full",children:[t.jsx(A,{className:"h-4 w-4 mr-2"}),"手動再生"]}),t.jsxs(y,{onClick:I,variant:"outline",className:"w-full",children:[t.jsx(V,{className:"h-4 w-4 mr-2"}),"再試行"]}),t.jsxs("div",{className:"mt-4",children:[t.jsx("h4",{className:"text-sm font-medium mb-2",children:"デバッグ情報:"}),t.jsx("div",{className:"bg-gray-800 text-green-400 p-3 rounded text-xs max-h-32 overflow-y-auto",children:w.map((e,a)=>t.jsx("div",{children:e},a))})]})]})]}):L?t.jsxs(E,{children:[t.jsx(R,{children:t.jsxs($,{className:"flex items-center gap-2",children:[t.jsx(T,{className:"h-5 w-5 animate-pulse"}),"MediaPipeとカメラを初期化中..."]})}),t.jsxs(M,{children:[t.jsx("div",{className:"flex items-center justify-center h-64",children:t.jsxs("div",{className:"text-center",children:[t.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600 mx-auto mb-2"}),t.jsx("p",{className:"text-gray-600",children:"初期化中..."})]})}),t.jsxs("div",{className:"mt-4",children:[t.jsx("h4",{className:"text-sm font-medium mb-2",children:"初期化ログ:"}),t.jsx("div",{className:"bg-gray-800 text-green-400 p-3 rounded text-xs max-h-32 overflow-y-auto",children:w.map((e,a)=>t.jsx("div",{children:e},a))})]})]})]}):t.jsxs("div",{className:"space-y-4",children:[t.jsxs("div",{className:"relative bg-black rounded-lg overflow-hidden",children:[t.jsx("video",{ref:i,className:"w-full h-auto",playsInline:!0,muted:!0,style:{display:l?"block":"none"}}),t.jsx("canvas",{ref:n,className:"absolute inset-0 w-full h-full",style:{display:l?"block":"none"}}),!l&&t.jsx("div",{className:"flex items-center justify-center h-64 bg-gray-100",children:t.jsxs("div",{className:"text-center",children:[t.jsx(T,{className:"h-8 w-8 mx-auto mb-2 text-gray-400"}),t.jsx("p",{className:"text-gray-600",children:"カメラを準備中..."})]})})]}),t.jsxs("div",{className:"flex gap-2",children:[t.jsxs(y,{onClick:I,variant:"outline",className:"flex items-center gap-2",children:[t.jsx(V,{className:"h-4 w-4"}),"再初期化"]}),u.current&&!l&&t.jsxs(y,{onClick:F,className:"flex items-center gap-2",children:[t.jsx(A,{className:"h-4 w-4"}),"手動再生"]}),l&&t.jsxs("div",{className:"flex items-center gap-2 text-sm text-gray-600",children:[t.jsx("div",{className:"w-2 h-2 bg-green-500 rounded-full"}),"カメラ準備完了"]})]}),t.jsxs(E,{children:[t.jsx(R,{children:t.jsx($,{className:"text-sm",children:"システム状況:"})}),t.jsx(M,{children:t.jsx("div",{className:"bg-gray-800 text-green-400 p-3 rounded text-xs max-h-32 overflow-y-auto",children:w.map((e,a)=>t.jsx("div",{children:e},a))})})]})]})};export{G as default};
