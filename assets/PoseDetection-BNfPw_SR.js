import{r as a,_ as W,j as t,C as b,a as C,b as R,T as B,c as P,B as F,d as T}from"./index-B3Gm1AoC.js";import{R as $}from"./rotate-ccw-DOlOZVPg.js";let L,k,E;const q=({onPoseResults:j,isActive:m})=>{const l=a.useRef(null),c=a.useRef(null),h=a.useRef(null),f=a.useRef(null),o=a.useRef(null),[p,M]=a.useState(!1),[O,S]=a.useState(!1),[_,x]=a.useState(null),[y,A]=a.useState([]),[i,z]=a.useState(!1),r=a.useCallback(e=>{try{console.log(`[PoseDetection] ${e}`);const s=new Date().toLocaleTimeString();A(d=>[...d.slice(-9),`${s}: ${e}`])}catch(s){console.error("Debug info error:",s)}},[]),v=a.useCallback(async()=>{try{S(!0),r("Starting MediaPipe Tasks Vision initialization...");const e=await W(()=>import("./vision_bundle-DieMjNca.js"),[]);L=e.FilesetResolver,k=e.PoseLandmarker,E=e.DrawingUtils,r("MediaPipe modules imported successfully");const s=await L.forVisionTasks("https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.22/wasm");r("FilesetResolver initialized with CDN WASM path"),h.current=await k.createFromOptions(s,{baseOptions:{modelAssetPath:"https://storage.googleapis.com/mediapipe-models/pose_landmarker/pose_landmarker_lite/float16/1/pose_landmarker_lite.task"},runningMode:"VIDEO",numPoses:1}),r("PoseLandmarker created successfully"),M(!0),x(null)}catch(e){r(`MediaPipe initialization failed: ${e.message}`),x(`MediaPipe初期化エラー: ${e.message}`),console.error("MediaPipe initialization error:",e)}finally{S(!1)}},[r]),D=a.useCallback(async()=>{try{r("Starting camera initialization..."),f.current&&f.current.getTracks().forEach(s=>s.stop());const e=await navigator.mediaDevices.getUserMedia({video:{width:{ideal:640},height:{ideal:480},facingMode:"user"}});f.current=e,r(`Camera stream obtained with ${e.getTracks().length} tracks`),l.current&&(l.current.srcObject=e,await l.current.play(),r("Video element playing successfully"),c.current&&(c.current.width=l.current.videoWidth||640,c.current.height=l.current.videoHeight||480,r(`Canvas size set to ${c.current.width}x${c.current.height}`)),z(!0),x(null))}catch(e){r(`Camera initialization failed: ${e.message}`),x(`カメラ初期化エラー: ${e.message}`),console.error("Camera initialization error:",e)}},[r]),w=a.useCallback(async()=>{if(!(!h.current||!l.current||!c.current||!i))try{const e=l.current,s=c.current,d=s.getContext("2d"),n=await h.current.detectForVideo(e,performance.now());if(d.clearRect(0,0,s.width,s.height),n.landmarks&&n.landmarks.length>0){const g=new E(d);for(const u of n.landmarks)g.drawLandmarks(u,{radius:U=>E.lerp(U.from.z,-.15,.1,5,1)}),g.drawConnectors(u,k.POSE_CONNECTIONS,{color:"#00FF00",lineWidth:2});const N=V(n.landmarks[0]);j&&j({landmarks:n.landmarks[0],jointAngles:N,timestamp:Date.now()})}m&&(o.current=requestAnimationFrame(w))}catch(e){r(`Pose detection error: ${e.message}`),console.error("Pose detection error:",e)}},[m,i,j,r]),V=e=>{const s=(d,n,g)=>{const N=Math.atan2(g.y-n.y,g.x-n.x)-Math.atan2(d.y-n.y,d.x-n.x);let u=Math.abs(N*180/Math.PI);return u>180&&(u=360-u),u};return{leftElbow:s(e[11],e[13],e[15]),rightElbow:s(e[12],e[14],e[16]),leftKnee:s(e[23],e[25],e[27]),rightKnee:s(e[24],e[26],e[28]),leftShoulder:s(e[13],e[11],e[23]),rightShoulder:s(e[14],e[12],e[24])}};a.useEffect(()=>{v()},[v]),a.useEffect(()=>{p&&!i&&D()},[p,i,D]),a.useEffect(()=>(m&&p&&i?(r("Starting pose detection..."),w()):!m&&o.current&&(r("Stopping pose detection..."),cancelAnimationFrame(o.current),o.current=null),()=>{o.current&&cancelAnimationFrame(o.current)}),[m,p,i,w,r]),a.useEffect(()=>()=>{f.current&&f.current.getTracks().forEach(e=>e.stop()),h.current&&h.current.close(),o.current&&cancelAnimationFrame(o.current)},[]);const I=()=>{x(null),z(!1),M(!1),v()};return _?t.jsxs(b,{children:[t.jsx(C,{children:t.jsxs(R,{className:"flex items-center gap-2 text-red-600",children:[t.jsx(B,{className:"h-5 w-5"}),"エラーが発生しました"]})}),t.jsxs(P,{className:"space-y-4",children:[t.jsx("p",{className:"text-gray-600",children:_}),t.jsxs(F,{onClick:I,className:"w-full",children:[t.jsx($,{className:"h-4 w-4 mr-2"}),"再試行"]}),t.jsxs("div",{className:"mt-4",children:[t.jsx("h4",{className:"text-sm font-medium mb-2",children:"デバッグ情報:"}),t.jsx("div",{className:"bg-gray-800 text-green-400 p-3 rounded text-xs max-h-32 overflow-y-auto",children:y.map((e,s)=>t.jsx("div",{children:e},s))})]})]})]}):O?t.jsxs(b,{children:[t.jsx(C,{children:t.jsxs(R,{className:"flex items-center gap-2",children:[t.jsx(T,{className:"h-5 w-5 animate-pulse"}),"MediaPipeとカメラを初期化中..."]})}),t.jsxs(P,{children:[t.jsx("div",{className:"flex items-center justify-center h-64",children:t.jsxs("div",{className:"text-center",children:[t.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600 mx-auto mb-2"}),t.jsx("p",{className:"text-gray-600",children:"初期化中..."})]})}),t.jsxs("div",{className:"mt-4",children:[t.jsx("h4",{className:"text-sm font-medium mb-2",children:"初期化ログ:"}),t.jsx("div",{className:"bg-gray-800 text-green-400 p-3 rounded text-xs max-h-32 overflow-y-auto",children:y.map((e,s)=>t.jsx("div",{children:e},s))})]})]})]}):t.jsxs("div",{className:"space-y-4",children:[t.jsxs("div",{className:"relative bg-black rounded-lg overflow-hidden",children:[t.jsx("video",{ref:l,className:"w-full h-auto",playsInline:!0,muted:!0,style:{display:i?"block":"none"}}),t.jsx("canvas",{ref:c,className:"absolute inset-0 w-full h-full",style:{display:i?"block":"none"}}),!i&&t.jsx("div",{className:"flex items-center justify-center h-64 bg-gray-100",children:t.jsxs("div",{className:"text-center",children:[t.jsx(T,{className:"h-8 w-8 mx-auto mb-2 text-gray-400"}),t.jsx("p",{className:"text-gray-600",children:"カメラを準備中..."})]})})]}),t.jsxs("div",{className:"flex gap-2",children:[t.jsxs(F,{onClick:I,variant:"outline",className:"flex items-center gap-2",children:[t.jsx($,{className:"h-4 w-4"}),"再初期化"]}),i&&t.jsxs("div",{className:"flex items-center gap-2 text-sm text-gray-600",children:[t.jsx("div",{className:"w-2 h-2 bg-green-500 rounded-full"}),"カメラ準備完了"]})]}),t.jsxs(b,{children:[t.jsx(C,{children:t.jsx(R,{className:"text-sm",children:"システム状況:"})}),t.jsx(P,{children:t.jsx("div",{className:"bg-gray-800 text-green-400 p-3 rounded text-xs max-h-32 overflow-y-auto",children:y.map((e,s)=>t.jsx("div",{children:e},s))})})]})]})};export{q as default};
