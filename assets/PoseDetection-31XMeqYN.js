import{r,_ as I,j as _}from"./index-DELx8uyN.js";let A,D,K;const X=({setDebugInfo:x,setError:u,onPoseResults:k})=>{const M=r.useRef(null),R=r.useRef(null),S=r.useRef(null),v=r.useRef(null),C=r.useRef(null),j=r.useRef(null),m=r.useRef(!0),[V,$]=r.useState(!1),[G,W]=r.useState(!1),[J,U]=r.useState(!1),o=r.useCallback(e=>{const t=new Date().toLocaleTimeString();console.log(`[PoseDetection] ${e}`),x==null||x(n=>[...n.slice(-99),`${t}: ${e}`])},[x]),l=r.useCallback((e,t="エラー")=>{var a;let n="";e instanceof Error?n=`${e.name}: ${e.message}`:e!=null&&e.message?n=String(e.message):(a=e==null?void 0:e.error)!=null&&a.message?n=String(e.error.message):typeof e=="object"?n=JSON.stringify(e):n=String(e),o(`${t}: ${n}`),u==null||u(`${t}: ${n}`),console.error(t,e)},[o,u]);r.useEffect(()=>{const e=n=>l(n,"window.error"),t=n=>l(n.reason??n,"unhandledrejection");return window.addEventListener("error",e),window.addEventListener("unhandledrejection",t),()=>{window.removeEventListener("error",e),window.removeEventListener("unhandledrejection",t)}},[l]);const F=r.useCallback(async()=>{var e,t;try{o("Requesting camera access...");const n=await navigator.mediaDevices.getUserMedia({video:{facingMode:"user",width:{ideal:1280},height:{ideal:720}},audio:!1});if(!m.current)return;if(C.current=n,!R.current){const s=document.createElement("video");s.playsInline=!0,s.muted=!0,s.autoplay=!0,s.style.display="none",R.current=s,(e=M.current)==null||e.appendChild(s)}if(!S.current){const s=document.createElement("canvas");s.className="absolute top-0 left-0 w-full h-full",S.current=s,(t=M.current)==null||t.appendChild(s)}const a=R.current;if(a.srcObject=n,await a.play(),!m.current)return;(()=>{const s=a.videoWidth||640,h=a.videoHeight||480,c=S.current;c&&(c.width!==s||c.height!==h)&&(c.width=s,c.height=h)})(),W(!0),o("Camera is ready.")}catch(n){throw l(n,"カメラ初期化エラー"),n}},[o,l]),P=r.useCallback(async()=>{try{o("Starting MediaPipe Tasks Vision initialization...");const e=await I(()=>import("./vision_bundle-DieMjNca.js"),[]);A=e.FilesetResolver,D=e.PoseLandmarker,K=e.DrawingUtils,o("MediaPipe modules imported successfully");const t=await A.forVisionTasks("https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.22/wasm");o("FilesetResolver initialized with CDN WASM path"),v.current=await D.createFromOptions(t,{baseOptions:{modelAssetPath:"https://storage.googleapis.com/mediapipe-models/pose_landmarker/pose_landmarker_lite/float16/latest/pose_landmarker_lite.task"},runningMode:"VIDEO",numPoses:1}),o("PoseLandmarker created successfully (GCS direct)."),U(!0),u==null||u(null)}catch(e){throw l(e,"MediaPipe初期化エラー"),e}},[o,l,u]),T=r.useCallback(()=>{const e=R.current,t=S.current,n=v.current;if(!e||!t||!n)return;const a=t.getContext("2d"),z=()=>{var s;if(m.current){(t.width!==e.videoWidth||t.height!==e.videoHeight)&&(t.width=e.videoWidth||640,t.height=e.videoHeight||480),a.save(),a.clearRect(0,0,t.width,t.height),a.drawImage(e,0,0,t.width,t.height);try{const h=performance.now(),c=n.detectForVideo(e,h);if((s=c==null?void 0:c.landmarks)!=null&&s.length){const N=new K(a);for(const d of c.landmarks)N.drawLandmarks(d,{radius:3}),N.drawConnectors(d,H);const E=c.landmarks[0],i=d=>(E==null?void 0:E[d])??null,w=(d,f,L)=>{if(!d||!f||!L)return 0;const p={x:d.x-f.x,y:d.y-f.y,z:(d.z||0)-(f.z||0)},g={x:L.x-f.x,y:L.y-f.y,z:(L.z||0)-(f.z||0)},q=p.x*g.x+p.y*g.y+p.z*g.z,O=Math.hypot(p.x,p.y,p.z),b=Math.hypot(g.x,g.y,g.z);if(!O||!b)return 0;const B=Math.min(1,Math.max(-1,q/(O*b)));return Math.acos(B)*180/Math.PI},y={leftElbow:w(i(11),i(13),i(15)),rightElbow:w(i(12),i(14),i(16)),leftKnee:w(i(23),i(25),i(27)),rightKnee:w(i(24),i(26),i(28)),leftShoulder:w(i(13),i(11),i(23)),rightShoulder:w(i(14),i(12),i(24))};a.fillStyle="#ffffff",a.font="14px monospace",a.fillText(`L-ELB: ${y.leftElbow.toFixed(1)}°`,10,20),a.fillText(`R-ELB: ${y.rightElbow.toFixed(1)}°`,10,38),a.fillText(`L-KNE: ${y.leftKnee.toFixed(1)}°`,10,56),a.fillText(`R-KNE: ${y.rightKnee.toFixed(1)}°`,10,74),k==null||k({jointAngles:y,timestamp:Date.now(),landmarks:E})}}catch(h){l(h,"推定ループエラー")}finally{a.restore()}j.current=requestAnimationFrame(z)}};z()},[k,l]),H=[[11,13],[13,15],[12,14],[14,16],[11,12],[11,23],[12,24],[23,25],[25,27],[24,26],[26,28]];return r.useEffect(()=>(m.current=!0,$(!0),(async()=>{try{await F(),await P(),m.current&&(o("Starting detection loop..."),T())}catch{}finally{$(!1)}})(),()=>{if(m.current=!1,j.current&&cancelAnimationFrame(j.current),v.current){try{v.current.close()}catch{}v.current=null}if(C.current){try{C.current.getTracks().forEach(e=>e.stop())}catch{}C.current=null}}),[F,P,T,o]),_.jsx("div",{ref:M,className:"relative w-full bg-black rounded-lg overflow-hidden",style:{paddingTop:"75%"},children:V&&_.jsx("div",{className:"absolute inset-0 flex items-center justify-center bg-black/70 text-white",children:_.jsx("p",{children:"MediaPipe / カメラ初期化中..."})})})};export{X as default};
