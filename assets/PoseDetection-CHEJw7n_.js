import{r as i,_ as I,j as z}from"./index-CL9HpUvX.js";let A,D,K;const X=({setDebugInfo:x,setError:u,onPoseResults:R})=>{const _=i.useRef(null),C=i.useRef(null),S=i.useRef(null),m=i.useRef(null),L=i.useRef(null),j=i.useRef(null),h=i.useRef(!0),[V,$]=i.useState(!1),[G,W]=i.useState(!1),[J,U]=i.useState(!1),o=i.useCallback(e=>{const n=new Date().toLocaleTimeString();console.log(`[PoseDetection] ${e}`),x==null||x(t=>[...t.slice(-99),`${n}: ${e}`])},[x]),l=i.useCallback((e,n="エラー")=>{var a;let t="";e instanceof Error?t=`${e.name}: ${e.message}`:e!=null&&e.message?t=String(e.message):(a=e==null?void 0:e.error)!=null&&a.message?t=String(e.error.message):typeof e=="object"?t=JSON.stringify(e):t=String(e),o(`${n}: ${t}`),u==null||u(`${n}: ${t}`),console.error(n,e)},[o,u]);i.useEffect(()=>{const e=t=>l(t,"window.error"),n=t=>l(t.reason??t,"unhandledrejection");return window.addEventListener("error",e),window.addEventListener("unhandledrejection",n),()=>{window.removeEventListener("error",e),window.removeEventListener("unhandledrejection",n)}},[l]);const P=i.useCallback(async()=>{var e,n;try{o("Requesting camera access...");const t=await navigator.mediaDevices.getUserMedia({video:{facingMode:"user",width:{ideal:1280},height:{ideal:720}},audio:!1});if(!h.current)return;if(L.current=t,!C.current){const s=document.createElement("video");s.playsInline=!0,s.muted=!0,s.autoplay=!0,s.style.display="none",C.current=s,(e=_.current)==null||e.appendChild(s)}if(!S.current){const s=document.createElement("canvas");s.className="absolute top-0 left-0 w-full h-full",S.current=s,(n=_.current)==null||n.appendChild(s)}const a=C.current;if(a.srcObject=t,await a.play(),!h.current)return;(()=>{const s=a.videoWidth||640,w=a.videoHeight||480,c=S.current;c&&(c.width!==s||c.height!==w)&&(c.width=s,c.height=w)})(),W(!0),o("Camera is ready.")}catch(t){throw l(t,"カメラ初期化エラー"),t}},[o,l]),F=i.useCallback(async()=>{try{o("Starting MediaPipe Tasks Vision initialization...");const e=await I(()=>import("./vision_bundle-DieMjNca.js"),[]);A=e.FilesetResolver,D=e.PoseLandmarker,K=e.DrawingUtils,o("MediaPipe modules imported successfully");const n=await A.forVisionTasks("https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.22");o("FilesetResolver initialized with CDN WASM path");const t=async a=>(o(`Creating PoseLandmarker with model: ${a}`),await D.createFromOptions(n,{baseOptions:{modelAssetPath:a},runningMode:"VIDEO",numPoses:1}));try{m.current=await t("/models/pose_landmarker_lite.task"),o("PoseLandmarker created successfully (local model).")}catch(a){l(a,"ローカルモデルで初期化失敗");const v="https://storage.googleapis.com/mediapipe-models/pose_landmarker/pose_landmarker_lite/float16/latest/pose_landmarker_lite.task";m.current=await t(v),o("PoseLandmarker created successfully (GCS fallback).")}U(!0),u==null||u(null)}catch(e){throw l(e,"MediaPipe初期化エラー"),e}},[o,l,u]),T=i.useCallback(()=>{const e=C.current,n=S.current,t=m.current;if(!e||!n||!t)return;const a=n.getContext("2d"),v=()=>{var s;if(h.current){(n.width!==e.videoWidth||n.height!==e.videoHeight)&&(n.width=e.videoWidth||640,n.height=e.videoHeight||480),a.save(),a.clearRect(0,0,n.width,n.height),a.drawImage(e,0,0,n.width,n.height);try{const w=performance.now(),c=t.detectForVideo(e,w);if((s=c==null?void 0:c.landmarks)!=null&&s.length){const N=new K(a);for(const d of c.landmarks)N.drawLandmarks(d,{radius:3}),N.drawConnectors(d,H);const E=c.landmarks[0],r=d=>(E==null?void 0:E[d])??null,g=(d,f,M)=>{if(!d||!f||!M)return 0;const p={x:d.x-f.x,y:d.y-f.y,z:(d.z||0)-(f.z||0)},y={x:M.x-f.x,y:M.y-f.y,z:(M.z||0)-(f.z||0)},q=p.x*y.x+p.y*y.y+p.z*y.z,b=Math.hypot(p.x,p.y,p.z),O=Math.hypot(y.x,y.y,y.z);if(!b||!O)return 0;const B=Math.min(1,Math.max(-1,q/(b*O)));return Math.acos(B)*180/Math.PI},k={leftElbow:g(r(11),r(13),r(15)),rightElbow:g(r(12),r(14),r(16)),leftKnee:g(r(23),r(25),r(27)),rightKnee:g(r(24),r(26),r(28)),leftShoulder:g(r(13),r(11),r(23)),rightShoulder:g(r(14),r(12),r(24))};a.fillStyle="#ffffff",a.font="14px monospace",a.fillText(`L-ELB: ${k.leftElbow.toFixed(1)}°`,10,20),a.fillText(`R-ELB: ${k.rightElbow.toFixed(1)}°`,10,38),a.fillText(`L-KNE: ${k.leftKnee.toFixed(1)}°`,10,56),a.fillText(`R-KNE: ${k.rightKnee.toFixed(1)}°`,10,74),R==null||R({jointAngles:k,timestamp:Date.now(),landmarks:E})}}catch(w){l(w,"推定ループエラー")}finally{a.restore()}j.current=requestAnimationFrame(v)}};v()},[R,l]),H=[[11,13],[13,15],[12,14],[14,16],[11,12],[11,23],[12,24],[23,25],[25,27],[24,26],[26,28]];return i.useEffect(()=>(h.current=!0,$(!0),(async()=>{try{await P(),await F(),h.current&&(o("Starting detection loop..."),T())}catch{}finally{$(!1)}})(),()=>{if(h.current=!1,j.current&&cancelAnimationFrame(j.current),m.current){try{m.current.close()}catch{}m.current=null}if(L.current){try{L.current.getTracks().forEach(e=>e.stop())}catch{}L.current=null}}),[P,F,T,o]),z.jsx("div",{ref:_,className:"relative w-full bg-black rounded-lg overflow-hidden",style:{paddingTop:"75%"},children:V&&z.jsx("div",{className:"absolute inset-0 flex items-center justify-center bg-black/70 text-white",children:z.jsx("p",{children:"MediaPipe / カメラ初期化中..."})})})};export{X as default};
